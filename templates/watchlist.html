{% extends "base.html" %}

{% block title %}Watchlist - Networth Tracker{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<!-- Watchlist Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="card-title mb-1">
                            <i class="fas fa-eye text-primary me-2"></i>
                            Stock Watchlist
                        </h2>
                        <p class="text-muted mb-0">
                            Track stocks you're interested in without owning them
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-success btn-lg me-2" onclick="showAddStockModal()">
                            <i class="fas fa-plus me-2"></i>Add Stock
                        </button>
                        <button class="btn btn-outline-primary btn-lg" id="updatePricesBtn" onclick="updateAllPrices()">
                            <i class="fas fa-sync-alt me-2"></i>Update Prices
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Watchlist Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-list fa-2x text-primary mb-2"></i>
                <h6 class="card-title">Total Stocks</h6>
                <h4 class="text-primary" id="totalStocks">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-arrow-up fa-2x text-success mb-2"></i>
                <h6 class="card-title">Gainers</h6>
                <h4 class="text-success" id="totalGainers">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-arrow-down fa-2x text-danger mb-2"></i>
                <h6 class="card-title">Losers</h6>
                <h4 class="text-danger" id="totalLosers">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-clock fa-2x text-info mb-2"></i>
                <h6 class="card-title">Last Updated</h6>
                <small class="text-muted" id="lastPriceUpdate">Never</small>
            </div>
        </div>
    </div>
</div>

<!-- Watchlist Table -->
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Your Watchlist
                </h5>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortWatchlist('symbol')">
                        <i class="fas fa-sort-alpha-down me-1"></i>Symbol
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortWatchlist('price')">
                        <i class="fas fa-sort-numeric-down me-1"></i>Price
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortWatchlist('change')">
                        <i class="fas fa-sort-amount-down me-1"></i>Change
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div id="watchlistContainer">
            <!-- Watchlist items will be populated here -->
            <div class="text-center py-5" id="emptyWatchlist">
                <i class="fas fa-eye fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Your Watchlist is Empty</h5>
                <p class="text-muted">Add stocks to track their performance without owning them.</p>
                <button class="btn btn-primary" onclick="showAddStockModal()">
                    <i class="fas fa-plus me-2"></i>Add Your First Stock
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Stock Modal -->
<div class="modal fade" id="addStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Stock to Watchlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStockForm" onsubmit="addStockToWatchlist(event)">
                    <div class="mb-3">
                        <label for="stockSymbol" class="form-label">Stock Symbol *</label>
                        <input type="text" class="form-control" id="stockSymbol" name="symbol" required
                            placeholder="e.g., AAPL, GOOGL, TSLA" style="text-transform: uppercase;">
                        <div class="form-text">Enter a valid stock ticker symbol</div>
                        <div id="symbolValidation" class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label for="stockNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="stockNotes" name="notes" rows="3"
                            placeholder="Why are you interested in this stock?"></textarea>
                        <div class="form-text">Optional notes about why you're tracking this stock</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Stock Validation:</strong> We'll verify the symbol exists and fetch current price data.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addStockForm" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Add to Watchlist
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Stock Confirmation Modal -->
<div class="modal fade" id="removeStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Remove Stock from Watchlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove <strong id="removeStockSymbol"></strong> from your watchlist?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmRemoveStock()">
                    <i class="fas fa-trash me-2"></i>Remove Stock
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Price Update Status Modal -->
<div class="modal fade" id="priceUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Updating Stock Prices</h5>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center">
                    <div class="spinner-border text-primary me-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>
                        <p class="mb-1">Fetching latest stock prices...</p>
                        <small class="text-muted" id="updateProgress">Initializing...</small>
                    </div>
                </div>
                <div class="progress mt-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="updateProgressBar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Watchlist management JavaScript
    let watchlistData = [];
    let currentSortField = 'symbol';
    let currentSortDirection = 'asc';
    let stockToRemove = null;

    document.addEventListener('DOMContentLoaded', function () {
        loadWatchlist();
    });

    function loadWatchlist() {
        fetch('/api/watchlist')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    watchlistData = data.watchlist || [];
                    renderWatchlist();
                    updateWatchlistSummary();

                    // Auto-update prices if they're stale (older than 1 hour) or missing
                    checkAndUpdateStalePrices();
                } else {
                    console.error('Failed to load watchlist:', data.error);
                    showAlert('Failed to load watchlist: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error loading watchlist:', error);
                showAlert('Error loading watchlist', 'danger');
            });
    }

    function checkAndUpdateStalePrices() {
        if (watchlistData.length === 0) return;

        const now = new Date();
        const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);

        let needsUpdate = false;

        for (const stock of watchlistData) {
            // Check if price is missing or stale
            if (!stock.current_price ||
                !stock.last_price_update ||
                new Date(stock.last_price_update) < oneHourAgo) {
                needsUpdate = true;
                break;
            }
        }

        if (needsUpdate) {
            console.log('Detected stale prices, updating automatically...');
            // Show a subtle notification
            showAlert('Updating stock prices...', 'info', 3000);

            // Update prices silently
            fetch('/api/watchlist/prices', {
                method: 'PUT'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Prices updated successfully');
                        // Reload watchlist to show updated prices
                        setTimeout(() => {
                            fetch('/api/watchlist')
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        watchlistData = data.watchlist || [];
                                        renderWatchlist();
                                        updateWatchlistSummary();
                                    }
                                });
                        }, 1000);
                    } else {
                        console.error('Failed to update prices:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error updating prices:', error);
                });
        }
    }

    function renderWatchlist() {
        const container = document.getElementById('watchlistContainer');
        let emptyState = document.getElementById('emptyWatchlist');

        if (watchlistData.length === 0) {
            // If empty state doesn't exist, create it
            if (!emptyState) {
                emptyState = document.createElement('div');
                emptyState.id = 'emptyWatchlist';
                emptyState.className = 'text-center py-5';
                emptyState.innerHTML = `
                    <i class="fas fa-eye fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Your Watchlist is Empty</h5>
                    <p class="text-muted">Add stocks to track their performance without owning them.</p>
                    <button class="btn btn-primary" onclick="showAddStockModal()">
                        <i class="fas fa-plus me-2"></i>Add Your First Stock
                    </button>
                `;
            }
            emptyState.style.display = 'block';
            container.innerHTML = '';
            container.appendChild(emptyState);
            return;
        }

        // Hide empty state if it exists
        if (emptyState) {
            emptyState.style.display = 'none';
        }

        // Sort data
        const sortedData = [...watchlistData].sort((a, b) => {
            let aVal = a[currentSortField];
            let bVal = b[currentSortField];

            if (currentSortField === 'price' || currentSortField === 'change') {
                aVal = parseFloat(aVal) || 0;
                bVal = parseFloat(bVal) || 0;
            }

            if (currentSortDirection === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += `
        <thead>
            <tr>
                <th>Symbol</th>
                <th>Current Price</th>
                <th>Daily Change</th>
                <th>% Change</th>
                <th>Notes</th>
                <th>Last Updated</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
    `;

        sortedData.forEach(stock => {
            const changeClass = (stock.daily_change >= 0) ? 'text-success' : 'text-danger';
            const changeIcon = (stock.daily_change >= 0) ? 'fa-arrow-up' : 'fa-arrow-down';
            const changePercent = stock.daily_change_percent || 0;
            const lastUpdate = stock.last_price_update ?
                new Date(stock.last_price_update).toLocaleString() : 'Never';

            html += `
            <tr>
                <td>
                    <strong>${stock.symbol}</strong>
                </td>
                <td>
                    <strong>$${(stock.current_price || 0).toFixed(2)}</strong>
                </td>
                <td class="${changeClass}">
                    <i class="fas ${changeIcon} me-1"></i>
                    $${Math.abs(stock.daily_change || 0).toFixed(2)}
                </td>
                <td class="${changeClass}">
                    <strong>${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%</strong>
                </td>
                <td>
                    <small class="text-muted">${stock.notes || 'No notes'}</small>
                </td>
                <td>
                    <small class="text-muted">${lastUpdate}</small>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-info me-1" onclick="updateSinglePrice('${stock.symbol}')" title="Update Price">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="showRemoveStockModal('${stock.symbol}')" title="Remove">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function updateWatchlistSummary() {
        const totalStocks = watchlistData.length;
        const gainers = watchlistData.filter(stock => (stock.daily_change || 0) > 0).length;
        const losers = watchlistData.filter(stock => (stock.daily_change || 0) < 0).length;

        document.getElementById('totalStocks').textContent = totalStocks;
        document.getElementById('totalGainers').textContent = gainers;
        document.getElementById('totalLosers').textContent = losers;

        // Find most recent update
        const lastUpdates = watchlistData
            .filter(stock => stock.last_price_update)
            .map(stock => new Date(stock.last_price_update))
            .sort((a, b) => b - a);

        if (lastUpdates.length > 0) {
            document.getElementById('lastPriceUpdate').textContent = lastUpdates[0].toLocaleString();
        }
    }

    function showAddStockModal() {
        const modal = new bootstrap.Modal(document.getElementById('addStockModal'));
        document.getElementById('addStockForm').reset();
        document.getElementById('stockSymbol').classList.remove('is-invalid');
        modal.show();
    }

    function addStockToWatchlist(event) {
        event.preventDefault();

        const symbol = document.getElementById('stockSymbol').value.toUpperCase().trim();
        const notes = document.getElementById('stockNotes').value.trim();

        if (!symbol) {
            showAlert('Please enter a stock symbol', 'warning');
            return;
        }

        // Check for duplicates
        if (watchlistData.some(stock => stock.symbol === symbol)) {
            document.getElementById('stockSymbol').classList.add('is-invalid');
            document.getElementById('symbolValidation').textContent = 'This stock is already in your watchlist';
            return;
        }

        const submitButton = document.querySelector('#addStockModal button[type="submit"]');
        if (!submitButton) {
            console.error('Submit button not found');
            return;
        }
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';
        submitButton.disabled = true;

        fetch('/api/watchlist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbol: symbol,
                notes: notes
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addStockModal')).hide();
                    showAlert(`${symbol} added to watchlist successfully!`, 'success');
                    loadWatchlist(); // Reload the watchlist
                } else {
                    if (data.error.includes('Invalid stock symbol')) {
                        document.getElementById('stockSymbol').classList.add('is-invalid');
                        document.getElementById('symbolValidation').textContent = 'Invalid stock symbol';
                    } else {
                        showAlert('Failed to add stock: ' + data.error, 'danger');
                    }
                }
            })
            .catch(error => {
                console.error('Error adding stock:', error);
                showAlert('Error adding stock to watchlist', 'danger');
            })
            .finally(() => {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
    }

    function showRemoveStockModal(symbol) {
        stockToRemove = symbol;
        document.getElementById('removeStockSymbol').textContent = symbol;
        const modal = new bootstrap.Modal(document.getElementById('removeStockModal'));
        modal.show();
    }

    function confirmRemoveStock() {
        if (!stockToRemove) return;

        fetch(`/api/watchlist/${stockToRemove}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('removeStockModal')).hide();
                    showAlert(`${stockToRemove} removed from watchlist`, 'success');
                    loadWatchlist(); // Reload the watchlist
                } else {
                    showAlert('Failed to remove stock: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error removing stock:', error);
                showAlert('Error removing stock from watchlist', 'danger');
            })
            .finally(() => {
                stockToRemove = null;
            });
    }

    function updateAllPrices() {
        if (watchlistData.length === 0) {
            showAlert('No stocks in watchlist to update', 'info');
            return;
        }

        // Update button state
        const updateBtn = document.getElementById('updatePricesBtn');
        const originalHTML = updateBtn.innerHTML;
        updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
        updateBtn.disabled = true;

        // Show progress modal
        const modal = new bootstrap.Modal(document.getElementById('priceUpdateModal'));
        modal.show();

        document.getElementById('updateProgress').textContent = 'Fetching latest stock prices...';
        document.getElementById('updateProgressBar').style.width = '25%';

        fetch('/api/watchlist/prices', {
            method: 'PUT'
        })
            .then(response => {
                document.getElementById('updateProgressBar').style.width = '75%';
                return response.json();
            })
            .then(data => {
                document.getElementById('updateProgressBar').style.width = '100%';

                setTimeout(() => {
                    modal.hide();

                    // Restore button state
                    updateBtn.innerHTML = originalHTML;
                    updateBtn.disabled = false;

                    if (data.success) {
                        const summary = data.summary || {};
                        const successful = summary.successful_updates || 0;
                        const failed = summary.failed_updates || 0;
                        const total = summary.total_items || 0;

                        let message = `Price update complete: ${successful}/${total} stocks updated`;
                        if (failed > 0) {
                            message += ` (${failed} failed)`;
                        }

                        showAlert(message, failed > 0 ? 'warning' : 'success');
                        loadWatchlist(); // Reload to show updated prices
                    } else {
                        showAlert('Failed to update prices: ' + (data.error || 'Unknown error'), 'danger');
                    }
                }, 500);
            })
            .catch(error => {
                modal.hide();

                // Restore button state
                updateBtn.innerHTML = originalHTML;
                updateBtn.disabled = false;

                console.error('Error updating prices:', error);
                showAlert('Error updating stock prices: ' + error.message, 'danger');
            });
    }

    function updateSinglePrice(symbol) {
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;

        // For single stock updates, we can call the batch update endpoint
        // The backend will handle updating just this stock
        fetch('/api/watchlist/prices', {
            method: 'PUT'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`${symbol} price updated`, 'success');
                    loadWatchlist(); // Reload to show updated price
                } else {
                    showAlert('Failed to update price: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error updating price:', error);
                showAlert('Error updating stock price', 'danger');
            })
            .finally(() => {
                button.innerHTML = originalHTML;
                button.disabled = false;
            });
    }

    function sortWatchlist(field) {
        if (currentSortField === field) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortField = field;
            currentSortDirection = 'asc';
        }

        renderWatchlist();
    }

    function showAlert(message, type, timeout = 5000) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);

        // Auto-dismiss after specified timeout
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, timeout);
    }

    // Auto-convert symbol input to uppercase
    document.getElementById('stockSymbol').addEventListener('input', function () {
        this.value = this.value.toUpperCase();
        this.classList.remove('is-invalid');
    });
</script>

{% endblock %}